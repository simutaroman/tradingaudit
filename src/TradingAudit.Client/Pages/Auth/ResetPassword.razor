@page "/reset-password"
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Class="pa-8">
        <MudText Typo="Typo.h5" Align="Align.Center" GutterBottom="true">Новий пароль</MudText>

        @if (string.IsNullOrEmpty(Code) || string.IsNullOrEmpty(Email))
        {
            <MudAlert Severity="Severity.Error">Невірне посилання відновлення.</MudAlert>
        }
        else
        {
            <MudForm @ref="_form">
                <MudTextField Value="@Email" Label="Email" ReadOnly="true" Variant="Variant.Filled" Class="mb-4" />

                <MudTextField @bind-Value="_newPassword" Label="Новий пароль"
                              InputType="InputType.Password" Required="true"
                              Variant="Variant.Outlined" Class="mb-4" />

                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                           OnClick="SubmitAsync" Disabled="_isLoading">
                    Змінити пароль
                </MudButton>
            </MudForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromQuery] public string? Code { get; set; }
    [SupplyParameterFromQuery] public string? Email { get; set; }

    private string _newPassword = "";
    private bool _isLoading = false;
    private MudForm _form;

    private async Task SubmitAsync()
    {
        _isLoading = true;

        // Code тут вже розкодований Blazor-ом, і Identity API (через JSON) прийме його нормально.
        // UrlEncode потрібен був для GET-запиту в ConfirmEmail,
        // а тут ми шлемо JSON в тілі POST-запиту, тому кодувати "+" не треба.
        var success = await AuthService.ResetPasswordAsync(Email, Code, _newPassword);

        _isLoading = false;

        if (success)
        {
            Snackbar.Add("Пароль змінено успішно!", Severity.Success);
            Navigation.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add("Не вдалося змінити пароль.", Severity.Error);
        }
    }
}